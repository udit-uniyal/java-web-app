pipeline {
  agent any
  options {
    buildDiscarder(logRotator(numToKeepStr: '5'))
  }
  stages {
    stage('Build') {
      steps {
        sh 'docker build -t darinpope/java-web-app:latest .'
      }
    }
stage('Install and run Container Scan') {
    steps {
      dir ('/var/lib/jenkins/workspace/Java-web-app-container-scan') {
        script {
            sh 'docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest --quiet image darinpope/java-web-app:latest -f json -o results.json'
        }
    }
 }
}
stage('Send result to AccuKnox') {
    steps {
        dir ('/var/lib/jenkins/workspace/Java-web-app-container-scan') {
            sh '''curl --location --request POST 'https://cspm.demo.accuknox.com/api/v1/artifact/?tenant_id=<tenantID>&data_type=TR&save_to_s3=false' \
            --header 'Tenant-Id: <tenantID>' \
            --header 'Authorization: Bearer <Token>' \
            --form 'file=@"./results.json"'
            '''        
        }
    }
  }
 }
}
